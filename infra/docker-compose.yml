version: "3.9"
services:
  backend:
    build:
      context: ..
      dockerfile: backend/Dockerfile
    env_file:
      - ../.env.example
    environment:
      - POSTGRES_URL=postgresql+psycopg://listenerrr:listenerrr@postgres:5432/listenerrr
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/1
      - CELERY_RESULT_BACKEND=redis://redis:6379/1
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=listenerrr
      - MINIO_SECRET_KEY=listenerrr123
      - OUTPUTS_DIR=/data/outputs
      - UPLOADS_DIR=/data/uploads
    ports:
      - "8000:8000"
    volumes:
      - ../backend:/app
      - ../storage/uploads:/data/uploads
      - ../outputs:/data/outputs
    depends_on:
      - postgres
      - redis
      - minio

  worker:
    build:
      context: ..
      dockerfile: backend/Dockerfile
    command: ["celery", "-A", "app.workers.pipeline.celery_app", "worker", "--loglevel=info"]
    env_file:
      - ../.env.example
    environment:
      - POSTGRES_URL=postgresql+psycopg://listenerrr:listenerrr@postgres:5432/listenerrr
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/1
      - CELERY_RESULT_BACKEND=redis://redis:6379/1
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=listenerrr
      - MINIO_SECRET_KEY=listenerrr123
      - OUTPUTS_DIR=/data/outputs
      - UPLOADS_DIR=/data/uploads
    volumes:
      - ../backend:/app
      - ../storage/uploads:/data/uploads
      - ../outputs:/data/outputs
    depends_on:
      - postgres
      - redis

  frontend:
    build:
      context: ../frontend
    environment:
      - VITE_API_BASE=http://localhost:8000/api/v1
    ports:
      - "4173:4173"
    depends_on:
      - backend

  postgres:
    image: postgres:15-alpine
    environment:
      - POSTGRES_DB=listenerrr
      - POSTGRES_USER=listenerrr
      - POSTGRES_PASSWORD=listenerrr
    ports:
      - "5432:5432"
    volumes:
      - ../postgres-data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - ../redis-data:/data

  minio:
    image: minio/minio:RELEASE.2024-08-17T01-24-54Z
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=listenerrr
      - MINIO_ROOT_PASSWORD=listenerrr123
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - ../minio-data:/data

  createbuckets:
    image: minio/mc:latest
    depends_on:
      - minio
    entrypoint: |
      /bin/sh -c "
        sleep 5 && \
        mc alias set local http://minio:9000 listenerrr listenerrr123 && \
        mc mb -p local/listenerrr-artifacts || true
      "
